(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{vlrY:function(e,n,t){"use strict";t.r(n),t.d(n,"_frontmatter",(function(){return b})),t.d(n,"default",(function(){return u}));t("91GP"),t("rGqo"),t("yt8O"),t("Btvt"),t("RW0V"),t("q1tI");var a=t("7ljp"),r=t("013z");t("qKvR");function l(){return(l=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e}).apply(this,arguments)}var m,b={},c=(m="InlineNotification",function(e){return console.warn("Component "+m+" was not imported, exported, or provided by MDXProvider as global scope"),Object(a.b)("div",e)}),o={_frontmatter:b},s=r.a;function u(e){var n=e.components,t=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,["components"]);return Object(a.b)(s,l({},o,t,{components:n,mdxType:"MDXLayout"}),Object(a.b)("p",null,"To support Kubernetes, changes to SPM were required.\nFor more information on these changes, refer to the\n",Object(a.b)("a",l({parentName:"p"},{href:"https://www.ibm.com/support/knowledgecenter/SS8S5A_7.0.10/com.ibm.curam.wlp.doc/Kubernetes/c_KubArchitecture.html"}),"Kubernetes Architecture")," section in\nthe Knowledge Center."),Object(a.b)("p",null,"When SPM is containerized on Kubernetes, it uses IBM® MQ to manage JMS messages for Cúram Deferred Processes and Cúram Workflows. IBM MQ is a queue managing service from the IBM stack. For more information about MQ, see ",Object(a.b)("a",l({parentName:"p"},{href:"https://www.ibm.com/support/knowledgecenter/SSFKSJ_9.1.0/com.ibm.mq.pro.doc/q001010_.htm"}),"here"),"."),Object(a.b)("p",null,"If MQ fails, certain functionality will be unusable. This includes and is not limited to, creation of a case and creation of an application."),Object(a.b)("p",null,"The MQ Cluster set up requires two queue managers nodes, with one active/primary queue manager, and one standby/secondary queue manager."),Object(a.b)("p",null,"Social Program Management supports only IBM MQ LTS on a VM. The steps below outline how to do this. In this runbook we will outline the steps to create:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",l({parentName:"li"},{href:"https://www.ibm.com/support/knowledgecenter/SSFKSJ_9.1.0/com.ibm.mq.pro.doc/q003090_.htm"}),"Queues")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",l({parentName:"li"},{href:"https://www.ibm.com/support/knowledgecenter/SSFKSJ_9.1.0/com.ibm.mq.pro.doc/q003300_.htm"}),"Listeners")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",l({parentName:"li"},{href:"https://www.ibm.com/support/knowledgecenter/SSFKSJ_9.1.0/com.ibm.mq.pro.doc/q003220_.htm"}),"Channels")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",l({parentName:"li"},{href:"https://www.ibm.com/support/knowledgecenter/SSFKSJ_9.1.0/com.ibm.mq.pro.doc/q003320_.htm"}),"Topics"))),Object(a.b)(c,{mdxType:"InlineNotification"},Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Note:")," The MQ version for this runbook verification is  9.1.0 LTS.")),Object(a.b)("p",null,"For the runbook, two standalone VMs were used as MQ nodes."),Object(a.b)("h3",null,"Queue manager names"),Object(a.b)("p",null,"For runbook configuration, the following naming conversion was used throughout the MQ setup: QM_NamingConvention_AppName. This must be unique, but ensure you change the commands used on this page accordingly."),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Queue Name:")),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"QM_minikube_curam")),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Channel Name:")," This value should be all capitals"),Object(a.b)("p",null,"CHL_NamingConvention_AppName"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"CHL_MINIKUBE_CURAM")),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Listeners Name:")," This value should be all capitals"),Object(a.b)("p",null,"LS_NamingConvention_AppName"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"LS_MINIKUBE_CURAM")),Object(a.b)("h2",null,"MQ stages"),Object(a.b)("p",null,"On both MQ nodes run the following command as root:"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"su - mqm # Changing user into mqm\nexport PATH=/opt/mqm/inst1/bin:$PATH\n")),Object(a.b)(c,{kind:"warning",mdxType:"InlineNotification"},Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Important!")),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"The above command is to be run on both MQ nodes and will be used throughout further commands in the runbook."))),Object(a.b)("h3",null,"Shared storage"),Object(a.b)("p",null,"Create the shared storage for our nodes."),Object(a.b)(c,{mdxType:"InlineNotification"},Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Note:")," Commands to be run as root.")),Object(a.b)("p",null,"On the shared node run the following command:"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"mkdir -p /MQHA/logs\nmkdir -p /MQHA/qmgrs\nmkdir -p /MQHA/scratch\nuseradd mqha -s /sbin/nologin\nchown -R mqha:mqha /MQHA/*\n")),Object(a.b)("p",null,"Verify that the UID and GUID match the owner ID"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),'echo "/MQHA  MQ.FQDN(rw,sync,no_wdelay,fsid=0,anonuid=1001,anongid=1001)" >> /etc/exports\n')),Object(a.b)("p",null,"Start and enable both the nfs service and rpcbind service by running the following command:"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"systemctl start nfs-server.service\nsystemctl enable nfs-server.service\nsystemctl start rpcbind\nsystemctl enable rpcbind\n")),Object(a.b)("p",null,"On MQ nodes run the following command:"),Object(a.b)(c,{mdxType:"InlineNotification"},Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Note:")," Commands to be run as root.")),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),'echo "SHAREDNODEADDRESS:/MQHA  /MQHA  nfs  defaults  0 0" >> /etc/fstab\nsystemctl start rpcbind\nsystemctl enable rpcbind\nmkdir -p /MQHA\nchmod 1777 /MQHA #Check permissions\nmount /MQHA\n')),Object(a.b)("h3",null,"Create QMs"),Object(a.b)("p",null,"When creating the queue, start on the secondary node first then move to the primary node."),Object(a.b)("p",null,"On the secondary MQ node, run the following command:"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"crtmqm -ld /MQHA/logs -md /MQHA/qmgrs QM_minikube_curam\ndspmqinf -o command QM_minikube_curam\n")),Object(a.b)("p",null,"Save the output of the above command. It should look like the following."),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"addmqinf -s QueueManager -v Name=QM_minikube_curam -v Directory=QM_minikube_curam -v Prefix=/var/mqm -v DataPath=/MQHA/qmgrs/QM_minikube_curam\n")),Object(a.b)("p",null,"Wait for /MQHA/qmgrs/QM_minikube_curam/qm.ini to appear on other node"),Object(a.b)("p",null,"On the primary MQ node run the following command:"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"addmqinf -s QueueManager -v Name=QM_minikube_curam -v Directory=QM_minikube_curam -v Prefix=/var/mqm -v DataPath=/MQHA/qmgrs/QM_minikube_curam\nstrmqm -x QM_minikube_curam\n")),Object(a.b)("p",null,"On the secondary MQ node run the following command:"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"strmqm -x QM_minikube_curam\n")),Object(a.b)("h3",null,"Create queues"),Object(a.b)("p",null,"On the primary MQ node run the following command:"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"runmqsc QM_minikube_curam <<-EOS\nDEFINE QLOCAL(QN.CURAMDEADMESSAGEQUEUE) CLWLUSEQ (ANY) DEFBIND (NOTFIXED)\nDEFINE QLOCAL(QN.WORKFLOWERROR) BOTHRESH(5) BOQNAME(QN.CURAMDEADMESSAGEQUEUE) CLWLUSEQ (ANY) DEFBIND (NOTFIXED)\nDEFINE QLOCAL(QN.WORKFLOWENACTMENT) BOTHRESH(5) BOQNAME(QN.WORKFLOWERROR) CLWLUSEQ (ANY) DEFBIND (NOTFIXED)\nDEFINE QLOCAL(QN.WORKFLOWACTIVITY) BOTHRESH(5) BOQNAME(QN.WORKFLOWERROR) CLWLUSEQ (ANY) DEFBIND (NOTFIXED)\nDEFINE QLOCAL(QN.DPERROR) BOTHRESH(5) BOQNAME(QN.CURAMDEADMESSAGEQUEUE) CLWLUSEQ (ANY) DEFBIND (NOTFIXED)\nDEFINE QLOCAL(QN.DPENACTMENT) BOTHRESH(5) BOQNAME(QN.DPERROR) CLWLUSEQ (ANY) DEFBIND (NOTFIXED)\nALTER QMGR CHLAUTH(DISABLED)\nALTER QMGR DEADQ(QN.CURAMDEADMESSAGEQUEUE)\nEOS\n")),Object(a.b)("h3",null,"Create listeners"),Object(a.b)("p",null,"On the primary MQ node run the following command:"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"runmqsc QM_minikube_curam <<-EOS\nDEFINE LISTENER (LS_MINIKUBE_CURAM) TRPTYPE (TCP) CONTROL (QMGR) PORT (1414)\nSTART LISTENER (LS_MINIKUBE_CURAM)\nEOS\n")),Object(a.b)("h3",null,"Create channels"),Object(a.b)("p",null,"On the primary MQ node run the following command:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"Enter your MQ node names into the commands below")),Object(a.b)(c,{mdxType:"InlineNotification"},Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Note:")," CERTLABL expects the value to be lower case ibmwebspheremq + Queue Name\nFor this example it will be ibmwebspheremqqm_minikube_curam")),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"runmqsc QM_minikube_curam <<-EOS\nDEFINE CHANNEL(CHL_MINIKUBE_CURAM) CHLTYPE(SVRCONN)  TRPTYPE(TCP) MCAUSER('mqm') SSLCIPH (TLS_RSA_WITH_AES_128_CBC_SHA256)  CERTLABL ('ibmwebspheremqqm_minikube_curam') SSLCAUTH (OPTIONAL) REPLACE\nDEFINE CHANNEL(CHL_MINIKUBE_CURAM) CHLTYPE(CLNTCONN) TRPTYPE(TCP) CONNAME('Node1(1414),Node2(1414)') QMNAME(QM_minikube_curam) SSLCIPH (TLS_RSA_WITH_AES_128_CBC_SHA256) CERTLABL ('ibmwebspheremqqm_minikube_curam') REPLACE\nEOS\n")),Object(a.b)("h3",null,"Create topics"),Object(a.b)("p",null,"On the primary MQ node run the following command:"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"runmqsc QM_minikube_curam <<-EOS\nDEFINE TOPIC (CURAMCACHEINVALIDATIONTOPIC) TOPICSTR (CURAMCACHEINVALIDATIONTOPIC)\nALTER QMGR CONNAUTH('CHECK.PWD')\nDEFINE AUTHINFO('CHECK.PWD') AUTHTYPE(IDPWOS) CHCKLOCL(OPTIONAL) CHCKCLNT(OPTIONAL)\nEOS\n")),Object(a.b)("h3",null,"Configure security"),Object(a.b)("p",null,"The configuration of the security works in four parts"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"Setting the object type."),Object(a.b)("li",{parentName:"ul"},"Creating the keystore and certs."),Object(a.b)("li",{parentName:"ul"},"Updating the certs on both nodes."),Object(a.b)("li",{parentName:"ul"},"Refreshing security settings.")),Object(a.b)(c,{mdxType:"InlineNotification"},Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Note:")," The application pods run as a non-root user (default). This non-root user must exist on both MQ nodes.")),Object(a.b)("p",null,"On the secondary MQ node run the following command:"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"useradd -g 0 -M default && usermod -L default\n")),Object(a.b)("p",null,"On the primary MQ node run the following command:"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"useradd -g 0 -M default && usermod -L default\nrunmqsc QM_minikube_curam <<-EOS\nSET AUTHREC OBJTYPE(QMGR) PRINCIPAL('default') AUTHADD(ALL)\nSET AUTHREC OBJTYPE(QUEUE) PROFILE('QN.DPENACTMENT') PRINCIPAL('default') AUTHADD(ALL)\nSET AUTHREC OBJTYPE(QUEUE) PROFILE('QN.DPERROR') PRINCIPAL('default') AUTHADD(ALL)\nSET AUTHREC OBJTYPE(QUEUE) PROFILE('QN.WORKFLOWACTIVITY') PRINCIPAL('default') AUTHADD(ALL)\nSET AUTHREC OBJTYPE(QUEUE) PROFILE('QN.WORKFLOWENACTMENT') PRINCIPAL('default') AUTHADD(ALL)\nSET AUTHREC OBJTYPE(QUEUE) PROFILE('QN.WORKFLOWERROR') PRINCIPAL('default') AUTHADD(ALL)\nSET AUTHREC OBJTYPE(QUEUE) PROFILE('QN.CURAMDEADMESSAGEQUEUE') PRINCIPAL('default') AUTHADD(ALL)\nSET AUTHREC OBJTYPE(LISTENER) PROFILE('LS_MINIKUBE_CURAM') PRINCIPAL('default') AUTHADD(ALL)\nSET AUTHREC OBJTYPE(CHANNEL) PROFILE('CHL_MINIKUBE_CURAM') PRINCIPAL('default') AUTHADD(ALL)\nSET AUTHREC OBJTYPE(CLNTCONN) PROFILE('CHL_MINIKUBE_CURAM') PRINCIPAL('default') AUTHADD(ALL)\nSET AUTHREC OBJTYPE(TOPIC) PROFILE('CURAMCACHEINVALIDATIONTOPIC') PRINCIPAL('default') AUTHADD(ALL)\nEOS\n")),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),'runmqckm -keydb -create -db /MQHA/qmgrs/QM_minikube_curam/ssl/key.kdb -type cms -pw Passw0rd -stash\nrunmqakm -cert -create -db /MQHA/qmgrs/QM_minikube_curam/ssl/key.kdb -stashed -label ibmwebspheremqqm_minikube_curam -size 2048 -dn "CN=QM_minikube_curam,O=IBM,C=US" -x509version 3 -expire 365 -sig_alg SHA1WithRSA\nrunmqakm -cert -extract -db /MQHA/qmgrs/QM_minikube_curam/ssl/key.kdb -stashed -label ibmwebspheremqqm_minikube_curam -target /MQHA/qmgrs/QM_minikube_curam/ssl/key_QM_minikube_curam.arm\nrunmqakm -cert -export -db /MQHA/qmgrs/QM_minikube_curam/ssl/key.kdb -stashed -label ibmwebspheremqqm_minikube_curam -target /MQHA/qmgrs/QM_minikube_curam/ssl/key_QM_minikube_curam.p12 -target_type pkcs12 -target_pw Passw0rd\n')),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"openssl pkcs12 -in /MQHA/qmgrs/QM_minikube_curam/ssl/key_QM_minikube_curam.p12 -passin pass:Passw0rd -nocerts -nodes | sed -ne '/-BEGIN PRIVATE KEY-/,/-END PRIVATE KEY-/p' > /MQHA/qmgrs/QM_minikube_curam/ssl/tls.key\nopenssl pkcs12 -in /MQHA/qmgrs/QM_minikube_curam/ssl/key_QM_minikube_curam.p12 -passin pass:Passw0rd -clcerts -nokeys | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > /MQHA/qmgrs/QM_minikube_curam/ssl/tls.crt\n")),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"runmqsc QM_minikube_curam <<-EOS\nALTER QMGR CONNAUTH('CHECK.PWD')\nDEFINE AUTHINFO('CHECK.PWD') AUTHTYPE(IDPWOS) CHCKLOCL(OPTIONAL) CHCKCLNT(OPTIONAL)\nREFRESH SECURITY TYPE(SSL)\nREFRESH SECURITY TYPE(AUTHSERV)\nREFRESH SECURITY TYPE(CONNAUTH)\nEOS\n")),Object(a.b)("p",null,"After these stages have been run MQ should be configured."),Object(a.b)("h3",null,"Clean up QMs/channels/listeners"),Object(a.b)("p",null,"These steps are to be used if reconfiguring MQ or cleanup of MQ."),Object(a.b)("p",null,"On both MQ nodes run the following command:"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"endmqm -w QM_minikube_curam\ndltmqm QM_minikube_curam\nrmvmqinf QM_minikube_curam\n")),Object(a.b)("p",null,"On either MQ node run the following command::"),Object(a.b)("pre",null,Object(a.b)("code",l({parentName:"pre"},{className:"language-shell"}),"rm -rf /MQHA/qmgrs/**\nrm -rf /MQHA/logs/**\nrm -rf /MQHA/scratch\nendmqm -w QM_minikube_curam\ndltmqm QM_minikube_curam\nrmvmqinf QM_minikube_curam\n")))}u.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-07-supporting-infrastructure-mq-setup-config-mdx-916dd45d4244893c5492.js.map